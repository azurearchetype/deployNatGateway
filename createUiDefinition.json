{
    "$schema": "https://schema.management.azure.com/schemas/0.1.2-preview/CreateUIDefinition.MultiVm.json#",
    "handler": "Microsoft.Azure.CreateUIDef", 
    "version": "0.1.2-preview",
    "parameters": {
        "basics": [
            {
                "name": "resourceGroupInfo",
                "type": "Microsoft.Common.InfoBox",
                "options": {
                    "icon": "Info",
                    "text": "üìã Resource Group Information: This deployment will create a NAT Gateway and associated Public IP address in the selected resource group. The NAT Gateway will be configured to work with an existing Virtual Network that may be located in this resource group or a different one that you specify in the next step."
                }
            },
            {
                "name": "regionInfo",
                "type": "Microsoft.Common.InfoBox",
                "options": {
                    "icon": "Warning",
                    "text": "üåç Region Selection: The NAT Gateway will be deployed in the region you select below. ‚ö†Ô∏è IMPORTANT: This region must match the region where your existing Virtual Network is located. NAT Gateways can only be associated with Virtual Networks in the same Azure region."
                }
            }
        ],
        "steps": [
            {
                "name": "networkConfig",
                "label": "Network Configuration",
                "subLabel": {
                    "preValidation": "Configure the virtual network and subnets",
                    "postValidation": "Done"
                },
                "bladeTitle": "Network Configuration",
                "elements": [
                    {
                        "name": "vnetInfo",
                        "type": "Microsoft.Common.InfoBox",
                        "options": {
                            "icon": "Info",
                            "text": "This template will deploy a NAT Gateway to an existing Virtual Network. To find your VNet details: 1) Go to Azure Portal ‚Üí Virtual Networks, 2) Note the VNet name and its resource group name, 3) Note the exact subnet names (case-sensitive), 4) Enter those details below."
                        }
                    },
                    {
                        "name": "vnetResourceGroup",
                        "type": "Microsoft.Common.TextBox",
                        "label": "Virtual Network Resource Group",
                        "toolTip": "Enter the name of the resource group containing your virtual network (leave empty to use current resource group)",
                        "constraints": {
                            "required": false,
                            "regex": "^[a-zA-Z0-9][a-zA-Z0-9_\\-\\.\\(\\)]*[a-zA-Z0-9_]$|^$",
                            "validationMessage": "Resource group name must be valid or empty"
                        }
                    },
                    {
                        "name": "vnetName",
                        "type": "Microsoft.Common.TextBox",
                        "label": "Virtual Network Name",
                        "toolTip": "Enter the name of your existing virtual network",
                        "constraints": {
                            "required": true,
                            "regex": "^[a-zA-Z0-9][a-zA-Z0-9_\\-\\.]*[a-zA-Z0-9_]$",
                            "validationMessage": "Virtual network name must be valid"
                        }
                    },
                    {
                        "name": "vnetValidation",
                        "type": "Microsoft.Common.InfoBox",
                        "visible": "[not(empty(steps('networkConfig').vnetName))]",
                        "options": {
                            "icon": "Info",
                            "text": "[concat('‚úÖ Please verify: VNet \"', steps('networkConfig').vnetName, '\" exists in resource group \"', if(empty(steps('networkConfig').vnetResourceGroup), resourceGroup().name, steps('networkConfig').vnetResourceGroup), '\". The deployment will fail if this VNet doesn\\'t exist.')]"
                        }
                    },
                    {
                        "name": "howToVerify",
                        "type": "Microsoft.Common.InfoBox",
                        "visible": "[not(empty(steps('networkConfig').vnetName))]",
                        "options": {
                            "icon": "Info",
                            "text": "üîç To verify: Go to Azure Portal ‚Üí Virtual Networks ‚Üí Search for your VNet name ‚Üí Confirm it exists in the correct resource group and note the subnet names."
                        }
                    },
                    {
                        "name": "subnetInfo",
                        "type": "Microsoft.Common.InfoBox",
                        "options": {
                            "icon": "Info",
                            "text": "Enter the subnets from your virtual network that you want to associate with the NAT Gateway. Use the check boxes to add additional subnets you want to associate with the NAT Gateway."
                        }
                    },
                    {
                        "name": "subnetValidationTip",
                        "type": "Microsoft.Common.InfoBox",
                        "visible": "[not(empty(steps('networkConfig').vnetName))]",
                        "options": {
                            "icon": "Warning",
                            "text": "‚ö†Ô∏è IMPORTANT: Make sure the subnet names you enter below exactly match the existing subnet names in your VNet. Case-sensitive!"
                        }
                    },
                    {
                        "name": "subnet1Name",
                        "type": "Microsoft.Common.TextBox",
                        "label": "Subnet 1 Name",
                        "toolTip": "Enter the name of the first subnet to associate with the NAT Gateway",
                        "constraints": {
                            "required": true,
                            "regex": "^[a-zA-Z0-9][a-zA-Z0-9_\\-\\.]*[a-zA-Z0-9_]$",
                            "validationMessage": "Subnet name must be valid"
                        }
                    },
                    {
                        "name": "includeSubnet2",
                        "type": "Microsoft.Common.CheckBox",
                        "label": "Include a second subnet"
                    },
                    {
                        "name": "subnet2Name",
                        "type": "Microsoft.Common.TextBox",
                        "label": "Subnet 2 Name", 
                        "toolTip": "Enter the name of the second subnet to associate with the NAT Gateway",
                        "visible": "[steps('networkConfig').includeSubnet2]",
                        "constraints": {
                            "required": "[steps('networkConfig').includeSubnet2]",
                            "regex": "^[a-zA-Z0-9][a-zA-Z0-9_\\-\\.]*[a-zA-Z0-9_]$",
                            "validationMessage": "Subnet name must be valid"
                        }
                    },
                    {
                        "name": "includeSubnet3",
                        "type": "Microsoft.Common.CheckBox",
                        "label": "Include a third subnet"
                    },
                    {
                        "name": "subnet3Name",
                        "type": "Microsoft.Common.TextBox",
                        "label": "Subnet 3 Name",
                        "toolTip": "Enter the name of the third subnet to associate with the NAT Gateway",
                        "visible": "[steps('networkConfig').includeSubnet3]",
                        "constraints": {
                            "required": "[steps('networkConfig').includeSubnet3]",
                            "regex": "^[a-zA-Z0-9][a-zA-Z0-9_\\-\\.]*[a-zA-Z0-9_]$",
                            "validationMessage": "Subnet name must be valid"
                        }
                    },
                    {
                        "name": "includeSubnet4",
                        "type": "Microsoft.Common.CheckBox",
                        "label": "Include a fourth subnet"
                    },
                    {
                        "name": "subnet4Name",
                        "type": "Microsoft.Common.TextBox",
                        "label": "Subnet 4 Name",
                        "toolTip": "Enter the name of the fourth subnet to associate with the NAT Gateway",
                        "visible": "[steps('networkConfig').includeSubnet4]",
                        "constraints": {
                            "required": "[steps('networkConfig').includeSubnet4]",
                            "regex": "^[a-zA-Z0-9][a-zA-Z0-9_\\-\\.]*[a-zA-Z0-9_]$",
                            "validationMessage": "Subnet name must be valid"
                        }
                    },
                    {
                        "name": "includeSubnet5",
                        "type": "Microsoft.Common.CheckBox",
                        "label": "Include a fifth subnet"
                    },
                    {
                        "name": "subnet5Name",
                        "type": "Microsoft.Common.TextBox", 
                        "label": "Subnet 5 Name",
                        "toolTip": "Enter the name of the fifth subnet to associate with the NAT Gateway",
                        "visible": "[steps('networkConfig').includeSubnet5]",
                        "constraints": {
                            "required": "[steps('networkConfig').includeSubnet5]",
                            "regex": "^[a-zA-Z0-9][a-zA-Z0-9_\\-\\.]*[a-zA-Z0-9_]$",
                            "validationMessage": "Subnet name must be valid"
                        }
                    },
                    {
                        "name": "deploymentSummary",
                        "type": "Microsoft.Common.InfoBox",
                        "visible": "[not(empty(steps('networkConfig').vnetName))]",
                        "options": {
                            "icon": "Info",
                            "text": "[concat('üìã Deployment Summary:\\n‚Ä¢ VNet: ', steps('networkConfig').vnetName, '\\n‚Ä¢ Resource Group: ', if(empty(steps('networkConfig').vnetResourceGroup), resourceGroup().name, steps('networkConfig').vnetResourceGroup), '\\n‚Ä¢ Primary Subnet: ', steps('networkConfig').subnet1Name, if(steps('networkConfig').includeSubnet2, concat('\\n‚Ä¢ Additional Subnets: ', steps('networkConfig').subnet2Name), ''), '\\n\\n‚ö†Ô∏è The deployment will validate these resources exist during execution.')]"
                        }
                    }
                ]
            },
            {
                "name": "natGatewayConfig",
                "label": "NAT Gateway Configuration",
                "subLabel": {
                    "preValidation": "Configure NAT Gateway and Public IP names",
                    "postValidation": "Done"
                },
                "bladeTitle": "NAT Gateway Configuration",
                "elements": [
                    {
                        "name": "natGatewayInfo",
                        "type": "Microsoft.Common.InfoBox",
                        "options": {
                            "icon": "Info",
                            "text": "üåê Configure the names for your NAT Gateway and its associated Public IP address. These resources will be created in the selected resource group and region."
                        }
                    },
                    {
                        "name": "natGatewayName",
                        "type": "Microsoft.Common.TextBox",
                        "label": "NAT Gateway Name",
                        "defaultValue": "[concat('natGateway-', take(uniqueString(resourceGroup().id), 8))]",
                        "toolTip": "Name for the NAT Gateway resource",
                        "constraints": {
                            "required": true,
                            "regex": "^[a-zA-Z0-9][a-zA-Z0-9_\\-\\.]*[a-zA-Z0-9_]$",
                            "validationMessage": "NAT Gateway name must be 1-80 characters and can contain letters, numbers, hyphens, periods, and underscores"
                        }
                    },
                    {
                        "name": "natGatewayNamingConvention",
                        "type": "Microsoft.Common.InfoBox",
                        "options": {
                            "icon": "Info",
                            "text": "üí° CAF Naming Convention Suggestion: Follow Azure Cloud Adoption Framework best practices with the format ng-<workload>-<environment>-<region>-01. Ex: ng-avd-infra-westus-01."
                        }
                    },
                    {
                        "name": "publicIpName",
                        "type": "Microsoft.Common.TextBox",
                        "label": "Public IP Name",
                        "defaultValue": "[concat('pip-natGateway-', take(uniqueString(resourceGroup().id), 8))]",
                        "toolTip": "Name for the public IP address resource",
                        "constraints": {
                            "required": true,
                            "regex": "^[a-zA-Z0-9][a-zA-Z0-9_\\-\\.]*[a-zA-Z0-9_]$",
                            "validationMessage": "Public IP name must be 1-80 characters and can contain letters, numbers, hyphens, periods, and underscores"
                        }
                    },
                    {
                        "name": "publicIpNamingConvention",
                        "type": "Microsoft.Common.InfoBox",
                        "options": {
                            "icon": "Info",
                            "text": "üí° CAF Naming Convention Suggestion: Follow Azure Cloud Adoption Framework best practices with the format pip-<workload>-<environment>-<region>-01. Ex: pip-avd-infra-westus-01."
                        }
                    }
                ]
            }
        ],
        "outputs": {
            "location": "[location()]",
            "vnetName": "[steps('networkConfig').vnetName]",
            "vnetResourceGroup": "[if(empty(steps('networkConfig').vnetResourceGroup), resourceGroup().name, steps('networkConfig').vnetResourceGroup)]", 
            "subnetNames": {
                "subnet1Name": "[steps('networkConfig').subnet1Name]",
                "includeSubnet2": "[steps('networkConfig').includeSubnet2]",
                "subnet2Name": "[steps('networkConfig').subnet2Name]",
                "includeSubnet3": "[steps('networkConfig').includeSubnet3]",
                "subnet3Name": "[steps('networkConfig').subnet3Name]",
                "includeSubnet4": "[steps('networkConfig').includeSubnet4]",
                "subnet4Name": "[steps('networkConfig').subnet4Name]",
                "includeSubnet5": "[steps('networkConfig').includeSubnet5]",
                "subnet5Name": "[steps('networkConfig').subnet5Name]"
            },
            "natGatewayName": "[steps('natGatewayConfig').natGatewayName]",
            "publicIpName": "[steps('natGatewayConfig').publicIpName]"
        }
    }
}
